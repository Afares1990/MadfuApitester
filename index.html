<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fly Nas — API Flow Tester (v3.1)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin: 18px; background:#f0f4f8; color:#0b1720; }
    .container { max-width: 1100px; margin: 0 auto; }
    h1 { font-size:28px; margin:0 0 6px; text-align:left; }
    .subtitle { color:#6b7280; margin:0 0 18px; }
    .card { background:#fff; border-radius:10px; padding:18px; box-shadow:0 4px 12px rgba(12,15,20,0.04); margin-bottom:18px; border:1px solid #e6eef8; }
    label { display:block; font-weight:700; margin-top:10px; color:#0b2b4a; }
    input, select, textarea, button { font-family:inherit; font-size:14px; }
    input[type="text"], input[type="number"], input[type="password"], select, textarea {
      width:100%; padding:10px; margin-top:6px; box-sizing:border-box; border-radius:6px; border:1px solid #dbe7f7; background:#fbfdff;
    }
    textarea { min-height:120px; resize:vertical; padding:12px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:14px; align-items:start; }
    .single { grid-column: 1 / -1; }
    .cred { border:2px solid #0b84ff; background:linear-gradient(180deg,#f0f8ff,#ffffff); padding:12px; border-radius:8px; }
    .cred label { color:#054ea6; margin-top:0; }
    .cred input { background:transparent; border:1px solid #cfe9ff; padding:8px; border-radius:6px; margin-top:8px; }
    .muted { color:#6b7280; font-size:13px; margin-top:6px; }
    .controls { display:flex; gap:8px; margin-top:12px; align-items:center; }
    .btn { padding:10px 14px; border-radius:8px; border:0; background:#0b84ff; color:#fff; cursor:pointer; font-weight:700; }
    .btn.ghost { background:transparent; border:1px solid #cfe9ff; color:#0b84ff; }
    .btn.secondary { background:#6b7280; color:#fff; }
    .log-mini { font-size:13px; color:#374151; background:#fbfdff; padding:8px; border-radius:8px; border:1px solid #e6eef8; }
    .success-box { display:none; background:#f0fff3; border:1px solid #b7f2c6; color:#065a2b; padding:12px; border-radius:8px; margin-top:12px; }
    .success-box a { color:#064e3b; font-weight:700; text-decoration:underline; }
    .log { white-space:pre-wrap; background:#0f1724; color:#cfe8ff; padding:12px; border-radius:8px; max-height:360px; overflow:auto; font-family:monospace; font-size:13px; border:1px solid #0b1220; }
    .log-collapsed { display:none; }
    .generate-row { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .disabled { opacity:0.5; pointer-events:none; }
    .small { font-size:13px; color:#475569; }
    .container-header { display:flex; justify-content:space-between; align-items:center; gap:18px; margin-bottom:8px; }
    .title-wrap { display:block; }
  </style>

  <!-- docx UMD (browser) for .docx generation -->
  <script src="https://unpkg.com/docx@9.0.2/build/index.umd.js"></script>
</head>
<body>
  <div class="container">
    <div class="container-header">
      <div class="title-wrap">
        <h1>Fly Nas — API Flow Tester (v3.1)</h1>
        <p class="subtitle">Flow: 1) Initialize Token → 2) Sign-in → 3) CreateOrder | PlatformTypeId default 5</p>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="previewOnly" class="btn ghost">Preview only</button>
        <button id="previewGenerate" class="btn secondary disabled" disabled>Preview & Generate Word</button>
      </div>
    </div>

    <!-- Environment -->
    <div class="card">
      <h2>Environment</h2>
      <div class="row">
        <div>
          <label>Base URL</label>
          <select id="baseUrl">
            <option value="https://api.staging.madfu.com.sa">Staging</option>
            <option value="https://api.madfu.com.sa">Production</option>
          </select>
        </div>
        <div>
          <label>Proxy URL (optional)</label>
          <input id="proxyUrl" value="/api/proxy" placeholder="Use /api/proxy after deploying to Vercel (or full https://your-app.vercel.app/api/proxy)" />
        </div>
      </div>

      <h3 style="margin-top:12px">Headers (required by API)</h3>
      <div class="row">
        <div class="cred">
          <label for="apiKey">APIKey</label>
          <input id="apiKey" placeholder="enter APIKey" autocomplete="off" />
        </div>
        <div class="cred">
          <label for="appCode">AppCode</label>
          <input id="appCode" placeholder="enter AppCode" autocomplete="off" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="cred">
          <label for="basicAuth">Authorization (Basic …)</label>
          <input id="basicAuth" placeholder="Basic xxxxxx (or only base64 — we will prefix)" autocomplete="off" />
        </div>
        <div>
          <label for="platformTypeId">PlatformTypeId</label>
          <input id="platformTypeId" value="5" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>System Info</label>
          <input id="systemInfo" value="web" />
        </div>
        <div>
          <label>UUID (auto)</label>
          <input id="runUuid" placeholder="auto-generated" />
        </div>
      </div>
    </div>

    <!-- Headers & Admin (keeping highlights) -->
    <div class="card">
      <h2>Admin & Dashboard</h2>
      <div class="row">
        <div class="cred">
          <label for="adminUser">AdminUser (Dashboard)</label>
          <input id="adminUser" placeholder="Admin@merchant.com" />
        </div>
        <div class="cred">
          <label for="adminPassword">Admin Password (Dashboard)</label>
          <input id="adminPassword" placeholder="Dashboard password" type="password" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Merchant Name (used for exported filename)</label>
          <input id="merchantName" placeholder="Merchant name (e.g. Roastery)" />
        </div>
        <div>
          <label>Dashboard name</label>
          <input id="dashboardName" value="Madfu Vendor Dashboard" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label for="otp">OTP (test)</label>
          <input id="otp" value="1001" />
        </div>
        <div>
          <!-- Changed from a <label> to a non-interactive <div> to avoid label click behavior affecting nearby inputs -->
          <div class="small">Madfu Vendor Dashboard: <a id="dashboardAnchor" href="https://vendor-staging-new.madfu.com.sa/login" target="_blank" rel="noopener">vendor-staging-new.madfu.com.sa/login</a></div>
        </div>
      </div>

      <!-- New inputs: Dashboard link and API Docs link (used for clickable links in generated DOCX) -->
      <div class="row" style="margin-top:10px;">
        <div>
          <label>Dashboard Link (used in generated document)</label>
          <input id="dashboardLink" value="https://vendor-staging-new.madfu.com.sa/login" placeholder="https://vendor-staging-new.madfu.com.sa/login" />
        </div>
        <div>
          <label>API Docs Link (used in generated document)</label>
          <input id="apiDocsLink" value="https://api.madfu.com.sa/docs" placeholder="https://api.madfu.com.sa/docs" />
        </div>
      </div>
    </div>

    <!-- Sign-in -->
    <div class="card">
      <h2>Sign-in</h2>
      <div class="row">
        <div class="cred">
          <label for="username">Username</label>
          <input id="username" placeholder="Cashier@Roastery.sa" autocomplete="off" />
        </div>
        <div class="cred">
          <label for="password">Password</label>
          <input id="password" type="password" placeholder="••••••••" autocomplete="off" />
        </div>
      </div>
    </div>

    <!-- Order payload (unchanged) -->
    <div class="card">
      <h2>Order Payload</h2>

      <div class="row">
        <div>
          <label>Taxes</label>
          <input id="taxes" type="number" value="0" />
        </div>
        <div>
          <label>ActualValue</label>
          <input id="actualValue" type="number" value="500" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Amount</label>
          <input id="amount" type="number" value="500" />
        </div>
        <div>
          <label>MerchantReference (auto)</label>
          <input id="merchantRef" placeholder="auto-generated" />
        </div>
      </div>

      <h3 style="margin-top:12px">OrderDetails (single item)</h3>
      <div class="row">
        <div><label>Product Name</label><input id="productName" value="coffee" /></div>
        <div><label>SKU</label><input id="sku" value="1" /></div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div><label>Product Image</label><input id="productImage" value="test" /></div>
        <div><label>Count</label><input id="count" type="number" value="1" /></div>
      </div>

      <label style="margin-top:10px">Total Amount</label>
      <input id="totalAmount" type="number" value="500" />

      <h3 style="margin-top:12px">Guest</h3>
      <div class="row">
        <div><label>Lang</label><input id="lang" value="en" /></div>
        <div><label>Customer Name</label><input id="customerName" value="Ahmed" /></div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div><label>Customer Mobile</label><input id="customerMobile" value="501110002" /></div>
        <div><label>Shipping Address</label><input id="shippingAddress" value="kingfahd" /></div>
      </div>

      <h3 style="margin-top:12px">Merchant URLs</h3>
      <div class="row">
        <div><label>Success</label><input id="successUrl" value="https://example.com/#/Success" /></div>
        <div><label>Failure</label><input id="failureUrl" value="https://example.com/#/Failure" /></div>
      </div>
      <label style="margin-top:10px">Cancel</label>
      <input id="cancelUrl" value="https://example.com/#/Cancel" />
    </div>

    <!-- Run & Logs -->
    <div class="card">
      <div style="display:flex; align-items:center; gap:12px;">
        <button id="runBtn" class="btn">Run Test ▶</button>
        <div class="small">After success, a checkout link appears and the Generate Document button will enable.</div>
      </div>

      <div id="successBox" class="success-box" role="status" aria-live="polite">
        <div><strong>Flow succeeded</strong></div>
        <div style="margin-top:8px">Checkout link: <a id="openCheckout" href="#" target="_blank" rel="noopener">(open)</a></div>
      </div>

      <div style="margin-top:12px;">
        <div class="log-mini">Logs are minimized by default — click to expand when needed.</div>
        <button id="toggleLogsBtn" class="btn ghost" style="margin-top:8px; margin-left:auto;">Show logs</button>
      </div>

      <div id="logContainer" style="margin-top:12px; display:none;">
        <div class="log" id="log"></div>
      </div>
    </div>

    <!-- Document generation -->
    <div class="card">
      <h2>Generate Merchant Document (.doc / .docx)</h2>
      <p class="small" style="white-space:pre-wrap;">Dears ,

                 I hope this email finds you well.

I am writing to you on behalf of the Madfu Integration team, serving as your primary point of contact for any inquiries related to our API integration. 
Our goal is to ensure a seamless and efficient experience for you as you integrate our API into your systems.
To assist you in this process, I would like to introduce you to our comprehensive documentation along with  testing credentials to facilitate the testing of the integration
These credentials will enable you to perform thorough testing and ensure that the integration meets your requirements and expectations:</p>

      <label for="messagePreview">Preview (editable before download)</label>
      <textarea id="messagePreview" placeholder="Preview will appear here"></textarea>

      <div class="generate-row">
        <button id="generateDocBtn" class="btn secondary disabled" disabled>Preview & Generate Word (.docx)</button>
        <button id="previewBtn" class="btn ghost">Preview only</button>
        <div class="small" style="margin-left:8px">DOCX is primary; a .doc fallback is kept for compatibility.</div>
      </div>
    </div>

  </div>

<script>
(function(){
  // docx alias (UMD)
  const docxLib = window.docx || null;
  const { Document, Paragraph, Table, TableRow, TableCell, Packer, TextRun, HeadingLevel, WidthType, ShadingType, ExternalHyperlink } = docxLib || {};

  // Intro paragraph to include in preview and generated docs
  const introText = `Dears ,\n\n                 I hope this email finds you well.\n\nI am writing to you on behalf of the Madfu Integration team, serving as your primary point of contact for any inquiries related to our API integration. \nOur goal is to ensure a seamless and efficient experience for you as you integrate our API into your systems.\nTo assist you in this process, I would like to introduce you to our comprehensive documentation along with  testing credentials to facilitate the testing of the integration\nThese credentials will enable you to perform thorough testing and ensure that the integration meets your requirements and expectations:`;

  // UI refs
  const logEl = document.getElementById('log');
  const logContainer = document.getElementById('logContainer');
  const toggleLogsBtn = document.getElementById('toggleLogsBtn');
  const successBox = document.getElementById('successBox');
  const openCheckout = document.getElementById('openCheckout');
  const runBtn = document.getElementById('runBtn');
  const generateDocBtn = document.getElementById('generateDocBtn');
  const previewBtn = document.getElementById('previewBtn');
  const messagePreview = document.getElementById('messagePreview');

  let logsVisible = false;
  let lastFlowSuccess = false;

  function log(title, data){ try{ const t = data===undefined? title : `${title} ${JSON.stringify(data,null,2)}`; const el = document.getElementById('log'); el.textContent = `[${new Date().toLocaleTimeString()}] ${t}\n` + (el.textContent||''); }catch(e){}
  }

  toggleLogsBtn?.addEventListener('click', () => {
    logsVisible = !logsVisible;
    document.getElementById('logContainer').style.display = logsVisible ? 'block' : 'none';
    toggleLogsBtn.textContent = logsVisible ? 'Hide logs' : 'Show logs';
  });

  function buildHeaders(includeToken, token) {
    const apiKey = document.getElementById('apiKey').value.trim();
    const appCode = document.getElementById('appCode').value.trim();
    let basicAuth = document.getElementById('basicAuth').value.trim();
    if (basicAuth && !basicAuth.startsWith('Basic ')) basicAuth = 'Basic ' + basicAuth;
    const platformTypeId = document.getElementById('platformTypeId').value.trim() || '5';
    const headers = {
      'accept': 'application/json',
      'content-type': 'application/json',
      'APIKey': apiKey,
      'AppCode': appCode,
      'Authorization': basicAuth,
      'PlatformTypeId': platformTypeId
    };
    if (includeToken && token) headers['Token'] = token;
    return headers;
  }

  async function doFetch(url, method, headers, body) {
    const res = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : undefined });
    const text = await res.text();
    let json = null;
    try { json = JSON.parse(text); } catch (e) {}
    return { status: res.status, headers: Object.fromEntries(res.headers.entries()), json, raw: text };
  }

  function withProxy(targetUrl) {
    const proxyBase = (document.getElementById('proxyUrl').value || '').trim();
    if (!proxyBase) return { url: targetUrl, viaProxy: false };
    return { url: `${proxyBase}?url=${encodeURIComponent(targetUrl)}`, viaProxy: true };
  }

  function findCheckoutLink(obj) {
    if (!obj) return null;
    const keys = ['checkoutLink','CheckoutLink','checkoutUrl','CheckoutUrl','paymentUrl','PaymentUrl','url','Url','payment_url','redirectUrl','redirect_url'];
    const tryKeys = (o, keys) => keys.map(k => o && typeof o === 'object' ? o[k] : undefined).find(v=>v);
    let found = tryKeys(obj, keys);
    if (found) return found;
    const nests = ['data','Data','result','Result','response','Response'];
    for (const n of nests) {
      if (obj[n]) {
        found = tryKeys(obj[n], keys);
        if (found) return found;
      }
    }
    try {
      const s = JSON.stringify(obj);
      const m = s.match(/https?:\/\/[^"'}\\s]+/);
      if (m) return m[0];
    } catch(e){}
    return null;
  }

  // compose message template with credentials removed from body (kept in the DOCX table)
  function composeMessage(state = {}) {
    const redactKeys = /(password|secret|token|card|cvv|apiKey|appCode|authorization|basicAuth)/i;

    function sanitize(value) {
      if (value == null) return value;
      if (Array.isArray(value)) return value.map(sanitize);
      if (typeof value === 'object') {
        const out = {};
        for (const [k, v] of Object.entries(value)) {
          if (redactKeys.test(k)) {
            out[k] = "[REDACTED]";
          } else {
            out[k] = sanitize(v);
          }
        }
        return out;
      }
      return value;
    }

    const lines = [];

    // Flow and environment
    lines.push(`Flow: ${state.flow || 'Initialize Token → Sign-in → CreateOrder'}`);
    if (state.baseUrl || state.proxyUrl) {
      lines.push(`Environment: ${state.baseUrl || ''}${state.proxyUrl ? ' (proxy: ' + state.proxyUrl + ')' : ''}`);
    }

    // Headers — do NOT include secret values here. Indicate they are in the DOCX.
    lines.push('');
    lines.push('Headers (values excluded — credentials are attached in the DOCX credentials table):');
    lines.push(`- APIKey: (included in DOCX)`);
    lines.push(`- AppCode: (included in DOCX)`);
    lines.push(`- Authorization / Basic: (included in DOCX)`);
    if (state.platformTypeId !== undefined) {
      lines.push(`- PlatformTypeId: ${state.platformTypeId}`);
    }

    // Include sanitized request/response payloads if present
    if (state.requestBody) {
      lines.push('');
      lines.push('Request payload (sensitive fields redacted):');
      try {
        lines.push(JSON.stringify(sanitize(state.requestBody), null, 2));
      } catch (e) {
        lines.push(String(state.requestBody));
      }
    }

    if (state.response) {
      lines.push('');
      lines.push('Response (sensitive fields redacted):');
      try {
        lines.push(JSON.stringify(sanitize(state.response), null, 2));
      } catch (e) {
        lines.push(String(state.response));
      }
    }

    // Additional debugging / logs if available
    if (state.logs) {
      lines.push('');
      lines.push('Logs:');
      lines.push(String(state.logs));
    }

    lines.push('');
    lines.push('Note: Sensitive credential values (APIKey, AppCode, Authorization) were intentionally excluded from this message body and will be included in the generated Word (DOCX) credential table[...]');

    return lines.join('\n');
  }

  // DOC fallback (same as previous)
  function downloadDoc(filename, text) {
    const html = `<!doctype html><html><head><meta charset="utf-8"><title>${filename}</title></head><body><pre style="font-family:Segoe UI, Arial, sans-serif; font-size:13px; white-space:pre-wrap;">${escapeHtml(text||'')}</pre></body></html>`;
    const blob = new Blob([html], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{URL.revokeObjectURL(url); a.remove();}, 500);
  }
  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // DOCX generation using docx library
  async function generateDocxFile(filename, creds) {
    if (!docxLib) {
      // fallback to DOC if docx lib not available
      let finalText = (messagePreview && messagePreview.value && messagePreview.value.trim()) ? messagePreview.value : composeMessage();
      if (!finalText.includes(introText.trim())) finalText = introText + '\n\n' + finalText;
      downloadDoc(filename.replace(/\.docx$/i, '.doc'), finalText);
      return;
    }

    // helper to create table cells with optional blue styling
    function cell(text, opts = {}) {
      const shading = opts.shade ? { type: ShadingType.CLEAR, fill: (opts.fill || 'E6F0FF'), color: 'auto' } : undefined;
      const run = new TextRun({ text: String(text), bold: !!opts.bold, color: opts.color || undefined });
      return new TableCell({
        shading,
        children: [ new Paragraph({ children: [ run ] }) ],
      });
    }

    // helper to create a cell that contains an external hyperlink when url provided
    function linkCell(text, url, opts = {}) {
      if (url && typeof url === 'string' && url.trim()) {
        return new TableCell({
          shading: opts.shade ? { type: ShadingType.CLEAR, fill: (opts.fill || 'E6F0FF'), color: 'auto' } : undefined,
          children: [
            new Paragraph({
              children: [
                new ExternalHyperlink({
                  children: [ new TextRun({ text: String(text || url), bold: !!opts.bold, color: opts.color || undefined, underline: {} }) ],
                  anchor: url
                })
              ]
            })
          ]
        });
      }
      return cell(text || '', opts);
    }

    // helper to convert a multi-line message into docx Paragraph nodes preserving blanks and leading spaces
    function paragraphNodesFromText(text){
      const t = String(text || '')
        .replace(/\r/g,'');
      // split into paragraphs by two or more newlines
      const paras = t.split(/\n{2,}/g);
      return paras.map(p => {
        // preserve leading spaces
        const leadingMatch = p.match(/^(\s*)/);
        const leading = leadingMatch ? leadingMatch[0] : '';
        const leadingNbsp = leading.replace(/ /g,'\u00A0').replace(/\t/g,'\u00A0\u00A0\u00A0\u00A0');
        const content = leadingNbsp + p.trimStart();
        return new Paragraph({ children: [ new TextRun({ text: content }) ] });
      });
    }

    // Build credential rows (blue labels on left) and include PlatformTypeId in the table
    const labelFill = 'E6F0FF';
    const labelColor = '0B66C2';

    const tableRows = [
      new TableRow({ children: [ cell('AUTHORIZATION', {shade:true, fill: labelFill, bold:true, color: labelColor}), cell(creds.authorization) ] }),
      new TableRow({ children: [ cell('APPCODE', {shade:true, fill: labelFill, bold:true, color: labelColor}), cell(creds.appCode) ] }),
      new TableRow({ children: [ cell('APIKEY', {shade:true, fill: labelFill, bold:true, color: labelColor}), cell(creds.apiKey) ] }),
      // Dashboard row — clickable when dashboardLink provided
      new TableRow({ children: [ cell('DASHBOARD', {shade:true, fill: labelFill, bold:true, color: labelColor}), linkCell(creds.dashboard || creds.dashboardLink || 'Dashboard', creds.dashboardLink, {shade:true}) ] }),
      new TableRow({ children: [ cell('Admin USER', {shade:true, fill: labelFill, bold:true, color: labelColor}), cell(creds.adminUser) ] }),
      new TableRow({ children: [ cell('Admin PASSWORD', {shade:true, fill: labelFill, bold:true, color: labelColor}), cell(creds.adminPassword) ] }),
      new TableRow({ children: [ cell('OTP', {shade:true, fill: labelFill, bold:true, color: labelColor}), cell(creds.otp) ] }),
      new TableRow({ children: [ cell('Creating Order USERNAME', {shade:true, fill: labelFill, bold:true, color: labelColor}), cell(creds.createUser) ] }),
      new TableRow({ children: [ cell('Creating Order PASSWORD', {shade:true, fill: labelFill, bold:true, color: labelColor}), cell(creds.createPass) ] }),
      // PlatformTypeId row moved into the table
      new TableRow({ children: [ cell('PlatformTypeId', {shade:true, fill: labelFill, bold:true, color: labelColor}), cell(creds.platformTypeId) ] }),
      // API Docs row — clickable when apiDocsLink provided
      new TableRow({ children: [ cell('API Docs', {shade:true, fill: labelFill, bold:true, color: labelColor}), linkCell(creds.apiDocsLink || 'API Docs', creds.apiDocsLink, {shade:false}) ] })
    ];

    const table = new Table({
      width: { size: 100, type: WidthType.PERCENTAGE },
      rows: tableRows
    });

    // Email-style body
    const subject = creds.headerTitle || 'Api documentation Guide';
    let bodyText = (messagePreview && messagePreview.value && messagePreview.value.trim()) ? messagePreview.value : composeMessage();
    if (!bodyText.includes(introText.trim())) bodyText = introText + '\n\n' + bodyText;

    const bodyParagraphs = paragraphNodesFromText(bodyText);

    const doc = new Document({
      sections: [{
        properties: {},
        children: [
          new Paragraph({ children: [ new TextRun({ text: `Subject: ${subject}`, bold: true }) ] }),
          new Paragraph({ text: '', spacing: { after: 200 } }),
          // insert composed/preview paragraphs preserving formatting
          ...bodyParagraphs,
          new Paragraph({ text: '', spacing: { after: 200 } }),

          // Credentials table
          new Paragraph({ text: '', spacing: { after: 100 } }),
          table,
          new Paragraph({ text: '', spacing: { after: 200 } }),

          // Credit-card test block & (PlatformTypeId moved to table)
          new Paragraph({ text: 'Test Card (for sandbox):', heading: HeadingLevel.HEADING_3 }),
          new Paragraph('Visa: 4111 1111 1111 1111  CVV: 123  Expiry: 05/25  Name: test'),

          new Paragraph({ text: '', spacing: { before: 200 } }),
          new Paragraph('Best regards,'),
          new Paragraph('Ahmed AbdelMaksoud'),
          new Paragraph('Madfu Integration Team')
        ]
      }]
    });

    // pack and download
    const blob = await Packer.toBlob(doc);
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 1000);
  }

  // preview-only button
  previewBtn.addEventListener('click', (e)=>{ e.preventDefault(); messagePreview.value = introText + '\n\n' + composeMessage(); log('Preview generated'); });

  // generate button (enabled after success)
  generateDocBtn.addEventListener('click', async (e)=>{ 
    e.preventDefault(); 
    if(!lastFlowSuccess){ alert('Generate is enabled only after a successful run.'); return; } 
    const merchant = (document.getElementById('merchantName')?.value || 'Merchant').replace(/[^a-z0-9-_ ]/ig,'').replace(/\s+/g,'_');
    const ts = new Date().toISOString().replace(/[:-]/g,'').replace(/\..+$/,'');
    const filenameDocx = `${merchant}_Madfu_Credentials_${ts}.docx`;
    const filenameDoc = `${merchant}_Madfu_Credentials_${ts}.doc`;
    const creds = {
      authorization: document.getElementById('basicAuth').value.trim() || '—',
      appCode: document.getElementById('appCode').value.trim() || '—',
      apiKey: document.getElementById('apiKey').value.trim() || '—',
      adminUser: document.getElementById('adminUser').value.trim() || '—',
      adminPassword: document.getElementById('adminPassword').value || '—',
      otp: document.getElementById('otp').value.trim() || '1001',
      createUser: document.getElementById('username').value.trim() || '—',
      createPass: document.getElementById('password').value || '—',
      headerTitle: `Api documentation Guide`,
      platformTypeId: document.getElementById('platformTypeId').value.trim() || '5',
      dashboard: document.getElementById('dashboardName').value.trim() || 'Madfu Vendor Dashboard',
      dashboardLink: document.getElementById('dashboardLink')?.value.trim() || '',
      apiDocsLink: document.getElementById('apiDocsLink')?.value.trim() || ''
    };

    // Ensure preview always contains the intro paragraph (prepend if missing)
    const composed = composeMessage();
    if (!messagePreview.value || !messagePreview.value.trim()) {
      messagePreview.value = introText + '\n\n' + composed;
    } else if (!messagePreview.value.includes(introText.trim())) {
      messagePreview.value = introText + '\n\n' + messagePreview.value;
    }

    // Try to generate docx; if docx lib not available or it fails, fallback to .doc
    try {
      await generateDocxFile(filenameDocx, creds);
      log('DOCX generated: ' + filenameDocx);
    } catch (err) {
      console.warn('DOCX generation failed, falling back to .doc', err);
      // ensure fallback has intro
      let fallbackText = messagePreview.value && messagePreview.value.trim() ? messagePreview.value : composed;
      if (!fallbackText.includes(introText.trim())) fallbackText = introText + '\n\n' + fallbackText;
      downloadDoc(filenameDoc, fallbackText);
      log('DOC fallback generated: ' + filenameDoc);
    }
  });

  // run flow
  runBtn.addEventListener('click', async () => {
    logEl && (document.getElementById('log').textContent = ''); // clear logs
    successBox.style.display = 'none';
    generateDocBtn.disabled = true;
    generateDocBtn.classList.add('disabled');
    lastFlowSuccess = false;

    const baseUrl = document.getElementById('baseUrl').value.trim();
    if(!baseUrl){ alert('Please choose Base URL'); return; }

    const theUuid = (crypto && crypto.randomUUID) ? crypto.randomUUID() : Math.random().toString(36).slice(2);
    document.getElementById('runUuid').value = theUuid;
    document.getElementById('merchantRef').value = document.getElementById('merchantRef').value || ('ref-' + Date.now());

    try {
      // init token
      const initEndpoint = `${baseUrl}/merchants/token/init`;
      const { url: initUrl } = withProxy(initEndpoint);
      const initHeaders = buildHeaders(false);
      log('Request Init Token → ' + initUrl);
      const initRes = await doFetch(initUrl, 'POST', initHeaders, { uuid: theUuid, systemInfo: document.getElementById('systemInfo').value });
      log('Init response ' + initRes.status);
      const initToken = initRes.json?.token || initRes.json?.Token || initRes.json?.data?.token || null;

      // sign in
      const signEndpoint = `${baseUrl}/Merchants/sign-in`;
      const { url: signUrl } = withProxy(signEndpoint);
      const signHeaders = buildHeaders(true, initToken);
      const signBody = { userName: document.getElementById('username').value.trim(), password: document.getElementById('password').value };
      log('Signing in → ' + signUrl);
      const signRes = await doFetch(signUrl, 'POST', signHeaders, signBody);
      log('Sign-in response ' + signRes.status);
      const signToken = signRes.json?.token || signRes.json?.Token || signRes.json?.data?.token || null;

      // create order
      const createEndpoint = `${baseUrl}/Merchants/Checkout/CreateOrder`;
      const { url: createUrl } = withProxy(createEndpoint);
      const createHeaders = buildHeaders(true, signToken);
      const createBody = {
        Order: {
          Taxes: Number(document.getElementById('taxes').value || 0),
          ActualValue: Number(document.getElementById('actualValue').value || 0),
          Amount: Number(document.getElementById('amount').value || 0),
          MerchantReference: document.getElementById('merchantRef').value || ('ref-' + Date.now())
        },
        OrderDetails: [{
          productName: document.getElementById('productName').value.trim(),
          SKU: document.getElementById('sku').value.trim(),
          productImage: document.getElementById('productImage').value.trim(),
          count: Number(document.getElementById('count').value || 1),
          totalAmount: Number(document.getElementById('totalAmount').value || 0)
        }],
        GuestOrderData: {
          Lang: document.getElementById('lang').value.trim(),
          CustomerName: document.getElementById('customerName').value.trim(),
          CustomerMobile: document.getElementById('customerMobile').value.trim(),
          ShippingAddress: document.getElementById('shippingAddress').value.trim()
        },
        MerchantUrls: {
          Success: document.getElementById('successUrl').value.trim(),
          Failure: document.getElementById('failureUrl').value.trim(),
          Cancel: document.getElementById('cancelUrl').value.trim()
        }
      };
      log('CreateOrder → ' + createUrl);
      const createRes = await doFetch(createUrl, 'POST', createHeaders, createBody);
      log('CreateOrder response ' + createRes.status);

      // extract link
      let link = findCheckoutLink(createRes.json ?? createRes.raw);
      if(!link && typeof createRes.raw === 'string'){ const m = createRes.raw.match(/https?:\/\/[^"'}\\s]+/); if(m) link = m[0]; }

      // success
      lastFlowSuccess = true;
      successBox.style.display = 'block';
      if(link){ openCheckout.href = link; openCheckout.textContent = link; } else { openCheckout.href = '#'; openCheckout.textContent = '(no checkout link)'; }
      generateDocBtn.disabled = false;
      generateDocBtn.classList.remove('disabled');
      messagePreview.value = introText + '\n\n' + composeMessage();
      log('Flow succeeded — generate enabled');
    } catch(err) {
      log('Error during flow: ' + (err && err.message ? err.message : err));
      lastFlowSuccess = false;
      successBox.style.display = 'none';
      generateDocBtn.disabled = true;
      generateDocBtn.classList.add('disabled');
      // show logs
      logsVisible = true;
      document.getElementById('logContainer').style.display = 'block';
      toggleLogsBtn.textContent = 'Hide logs';
    }
  });

  // helpers
  function uuid(){ return (crypto && crypto.randomUUID) ? crypto.randomUUID() : Math.random().toString(36).slice(2); }
  function uniqueRef(){ return 'ref-' + Date.now(); }

  // initial
  generateDocBtn.disabled = true;
  messagePreview.value = introText + '\n\n' + composeMessage();
  log('UI ready — fill credentials and run the flow.');

  // helper functions used by run flow
  function withProxy(targetUrl) {
    const proxyBase = (document.getElementById('proxyUrl').value || '').trim();
    if (!proxyBase) return { url: targetUrl, viaProxy: false };
    return { url: `${proxyBase}?url=${encodeURIComponent(targetUrl)}`, viaProxy: true };
  }
  function doFetch(url, method, headers, body){
    return fetch(url, {method, headers, body: body ? JSON.stringify(body): undefined})
      .then(async res => {
        const text = await res.text(); let json=null; try{json=JSON.parse(text)}catch(e){}
        return {status:res.status, headers:Object.fromEntries(res.headers.entries()), json, raw: text};
      });
  }
  function findCheckoutLink(obj){
    if(!obj) return null;
    const keys=['checkoutLink','CheckoutLink','checkoutUrl','CheckoutUrl','paymentUrl','PaymentUrl','url','Url','payment_url','redirectUrl','redirect_url'];
    const tryKeys=(o,keys)=>keys.map(k=>o&&typeof o === 'object'?o[k]:undefined).find(v=>v);
    let found=tryKeys(obj,keys); if(found) return found;
    const nests=['data','Data','result','Result','response','Response'];
    for(const n of nests){ if(obj[n]){ found=tryKeys(obj[n],keys); if(found) return found; } }
    try{ const s=JSON.stringify(obj); const m=s.match(/https?:\/\/[^"'}\\s]+/); if(m) return m[0]; }catch(e){}
    return null;
  }

})();
</script>
</body>
</html>