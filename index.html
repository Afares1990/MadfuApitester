
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fly Nas — Flow Tester (v3.1 Diagnostics)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; line-height: 1.35; }
    h1,h2 { margin: 0 0 12px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    label { display: block; font-weight: 600; margin-top: 8px; }
    input, select { width: 100%; padding: 8px; margin-top: 4px; }
    button { margin-top: 12px; padding: 10px 16px; font-weight: 600; }
    .log { white-space: pre-wrap; background: #f8f9fa; border: 1px dashed #ccc; padding: 12px; border-radius: 8px; max-height: 50vh; overflow: auto; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .muted { color: #666; font-size: 0.9em; }
    .danger { color: #b00020; }
  </style>
</head>
<body>
  <h1>Fly Nas — API Flow Tester (v3.1)</h1>
  <p class="muted">Flow: <strong>1) Initialize Token → 2) Sign-in → 3) CreateOrder</strong> | PlatformTypeId fixed to <strong>5</strong></p>

  <div class="card">
    <h2>Environment</h2>
    <div class="row">
      <div>
        <label>Base URL</label>
        <select id="baseUrl">
          <option value="https://api.staging.madfu.com.sa">Staging</option>
          <option value="https://api.madfu.com.sa">Production</option>
        </select>
      </div>
      <div>
        <label>Proxy URL (optional)</label>
        <input id="proxyUrl" placeholder="https://YOUR-VERCEL-APP.vercel.app/api/proxy (leave blank to call API directly)" />
      </div>
    </div>

    <h3>Headers (required by API)</h3>
    <div class="row">
      <div>
        <label>APIKey</label>
        <input id="apiKey" placeholder="enter APIKey" />
      </div>
      <div>
        <label>AppCode</label>
        <input id="appCode" placeholder="enter AppCode" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Authorization (Basic …)</label>
        <input id="basicAuth" placeholder="Basic xxxxxx (or only base64 — we will prefix)" />
      </div>
      <div>
        <label>PlatformTypeId</label>
        <input id="platformTypeId" value="5" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>System Info</label>
        <input id="systemInfo" value="web" />
      </div>
      <div>
        <label>UUID (auto)</label>
        <input id="runUuid" placeholder="auto-generated" />
      </div>
    </div>

    <h3>Sign-in</h3>
    <div class="row">
      <div>
        <label>Username</label>
        <input id="username" placeholder="user@example.com" />
      </div>
      <div>
        <label>Password</label>
        <input id="password" type="password" placeholder="••••••••" />
      </div>
    </div>
    <p class="muted danger">Do not commit real keys or credentials to Git — fill them at runtime.</p>
  </div>

  <div class="card">
    <h2>Order Payload</h2>
    <div class="row">
      <div>
        <label>Taxes</label>
        <input id="taxes" type="number" value="0" />
      </div>
      <div>
        <label>ActualValue</label>
        <input id="actualValue" type="number" value="500" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Amount</label>
        <input id="amount" type="number" value="500" />
      </div>
      <div>
        <label>MerchantReference (auto)</label>
        <input id="merchantRef" placeholder="auto-generated" />
      </div>
    </div>

    <h3>OrderDetails (single item)</h3>
    <div class="row">
      <div><label>Product Name</label><input id="productName" value="coffee" /></div>
      <div><label>SKU</label><input id="sku" value="1" /></div>
    </div>
    <div class="row">
      <div><label>Product Image</label><input id="productImage" value="test" /></div>
      <div><label>Count</label><input id="count" type="number" value="1" /></div>
    </div>
    <label>Total Amount</label>
    <input id="totalAmount" type="number" value="500" />

    <h3>Guest</h3>
    <div class="row">
      <div><label>Lang</label><input id="lang" value="en" /></div>
      <div><label>Customer Name</label><input id="customerName" value="Ahmed" /></div>
    </div>
    <div class="row">
      <div><label>Customer Mobile</label><input id="customerMobile" value="501110002" /></div>
      <div><label>Shipping Address</label><input id="shippingAddress" value="kingfahd" /></div>
    </div>

    <h3>Merchant URLs</h3>
    <div class="row">
      <div><label>Success</label><input id="successUrl" value="https://example.com/#/Success" /></div>
      <div><label>Failure</label><input id="failureUrl" value="https://example.com/#/Failure" /></div>
    </div>
    <label>Cancel</label>
    <input id="cancelUrl" value="https://example.com/#/Cancel" />
  </div>

  <div class="card">
    <button id="runBtn">Run Test ▶</button>
    <div class="log" id="log"></div>
  </div>

<script>
(function() {
  const logEl = document.getElementById('log');
  const uuid = () => (crypto && crypto.randomUUID) ? crypto.randomUUID() : Math.random().toString(36).slice(2);
  const uniqueRef = () => 'ref-' + Date.now();

  function appendLog(title, data) {
    const safe = (v) => typeof v === 'string' ? v : JSON.stringify(v, null, 2);
    logEl.textContent += `\n\n=== ${title} ===\n` + safe(data);
  }

  function buildHeaders(includeToken, token) {
    const apiKey = document.getElementById('apiKey').value.trim();
    const appCode = document.getElementById('appCode').value.trim();
    let basicAuth = document.getElementById('basicAuth').value.trim();
    if (basicAuth && !basicAuth.startsWith('Basic ')) basicAuth = `Basic ${basicAuth}`;
    const platformTypeId = document.getElementById('platformTypeId').value.trim() || '5';

    const headers = {
      'accept': 'application/json',
      'content-type': 'application/json',
      'APIKey': apiKey,
      'AppCode': appCode,
      'Authorization': basicAuth,
      'PlatformTypeId': platformTypeId
    };
    if (includeToken && token) headers['Token'] = token;
    return headers;
  }

  async function doFetch(url, method, headers, body) {
    try {
      const res = await fetch(url, {
        method,
        headers,
        body: body ? JSON.stringify(body) : undefined
      });
      const status = res.status;
      const text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch { json = null; }

      if (!res.ok) {
        throw {
          status,
          headers: Object.fromEntries(res.headers.entries()),
          json,
          raw: text
        };
      }
      return json ?? { raw: text };
    } catch (e) {
      throw {
        fetchError: true,
        message: e?.message || String(e),
        details: e
      };
    }
  }

  function withProxy(targetUrl) {
    const proxyBase = (document.getElementById('proxyUrl').value || '').trim();
    if (!proxyBase) return { url: targetUrl, viaProxy: false };
    const proxied = `${proxyBase}?url=${encodeURIComponent(targetUrl)}`;
    return { url: proxied, viaProxy: true };
  }

  document.getElementById('runBtn').addEventListener('click', async () => {
    logEl.textContent = '';
    const baseUrl = document.getElementById('baseUrl').value.trim();
    const systemInfo = document.getElementById('systemInfo').value.trim();
    const userName = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;

    const theUuid = uuid();
    document.getElementById('runUuid').value = theUuid;
    document.getElementById('merchantRef').value = uniqueRef();

    try {
      // Step 1: Initialize Token
      const initEndpoint = `${baseUrl}/merchants/token/init`;
      const initBody = { uuid: theUuid, systemInfo };
      const { url: initUrl } = withProxy(initEndpoint);
      const initHeaders = buildHeaders(false);
      const initResp = await doFetch(initUrl, 'POST', initHeaders, initBody);
      appendLog('Init Token Response', initResp);
      const initToken = initResp?.token || initResp?.Token || initResp?.data?.token || initResp?.Data?.Token || initResp?.result?.token || initResp?.Result?.Token;

      // Step 2: Sign-in
      const signEndpoint = `${baseUrl}/Merchants/sign-in`;
      const signBody = { userName, password };
      const { url: signUrl } = withProxy(signEndpoint);
      const signHeaders = buildHeaders(true, initToken);
      const signResp = await doFetch(signUrl, 'POST', signHeaders, signBody);
      appendLog('Sign-in Response', signResp);
      const signinToken = signResp?.token || signResp?.Token || signResp?.data?.token || signResp?.Data?.Token || signResp?.result?.token || signResp?.Result?.Token;

      // Step 3: CreateOrder
      const taxes = Number(document.getElementById('taxes').value);
      const actualValue = Number(document.getElementById('actualValue').value);
      const amount = Number(document.getElementById('amount').value);
      const merchantReference = document.getElementById('merchantRef').value || uniqueRef();

      const orderDetails = [{
        productName: document.getElementById('productName').value.trim(),
        SKU: document.getElementById('sku').value.trim(),
        productImage: document.getElementById('productImage').value.trim(),
        count: Number(document.getElementById('count').value),
        totalAmount: Number(document.getElementById('totalAmount').value)
      }];

      const guestOrderData = {
        Lang: document.getElementById('lang').value.trim(),
        CustomerName: document.getElementById('customerName').value.trim(),
        CustomerMobile: document.getElementById('customerMobile').value.trim(),
        ShippingAddress: document.getElementById('shippingAddress').value.trim()
      };

      const merchantUrls = {
        Success: document.getElementById('successUrl').value.trim(),
        Failure: document.getElementById('failureUrl').value.trim(),
        Cancel: document.getElementById('cancelUrl').value.trim()
      };

      const createEndpoint = `${baseUrl}/Merchants/Checkout/CreateOrder`;
      const { url: createUrl } = withProxy(createEndpoint);
      const createHeaders = buildHeaders(true, signinToken);
      const createBody = {
        Order: {
          Taxes: taxes,
          ActualValue: actualValue,
          Amount: amount,
          MerchantReference: merchantReference
        },
        OrderDetails: orderDetails,
        GuestOrderData: guestOrderData,
        MerchantUrls: merchantUrls
      };
      const createResp = await doFetch(createUrl, 'POST', createHeaders, createBody);
      appendLog('CreateOrder Response', createResp);

      appendLog('Flow Completed', { uuid: theUuid, merchantReference });
    } catch (err) {
      appendLog('Error', err);
    }
  });
})();
</script>
</body>
</html>
